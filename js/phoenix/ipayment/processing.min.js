function ipaymentObserver(b){if(payment.currentMethod=="ipayment_cc"){var a=new ipaymentMultishipping();if($("ipayment_cc_request_status").value!="SUCCESS"){a.save();Event.stop(b)}}if(payment.currentMethod=="ipayment_elv"){var a=new ipaymentMultishipping();if($("ipayment_elv_request_status").value!="SUCCESS"){a.save();Event.stop(b)}}}Event.observe(window,"load",function(){Validation.creditCartTypes.set("VI",[new RegExp("^4[0-9]{12}([0-9]{3}|[0-9]{6})?$"),new RegExp("^[0-9]{3}$"),true]);Validation.creditCartTypes.set("DI",[new RegExp("^6011[0-9]{12}$"),new RegExp("^[0-9]{3}$"),true]);Validation.creditCartTypes.set("DC",[new RegExp("^(30[0-5]|36|38)[0-9]{11,12}$"),new RegExp("^[0-9]{3}$"),true]);Validation.creditCartTypes.set("SS",[false,new RegExp("^([0-9]{3}|[0-9]{4})$"),false]);Validation.creditCartTypes.set("MO",[new RegExp("^(67[0-9]{2}|6400)[0-9]{9,15}$"),new RegExp("^([0-9]{3}|[0-9]{4})?$"),true]);Validation.creditCartTypes.set("JC",[new RegExp("^35(2[8-9]|[3-8])[0-9]{12,13}$"),new RegExp("^([0-9]{3}|[0-9]{4})?$"),true]);Validation.creditCartTypes.set("CB",[false,new RegExp("^([0-9]{3}|[0-9]{4})?$"),false]);var a=$("multishipping-billing-form");if(a){Event.observe(a,"submit",ipaymentObserver);return}payment.save=payment.save.wrap(function(b){if(this.currentMethod&&this.currentMethod.substr(0,9)=="ipayment_"){if(checkout.loadWaiting!=false){return}var d=new Validation(this.form);if(this.validate()&&d.validate()){checkout.setLoadWaiting("payment");if(this.currentMethod.substr(9)=="cc"){var c=new ipaymentApplication();var e=c.buildCcData();c.sendIpaymentRequest(e,cc_trxuser_id,"processOnepagecheckoutResponse")}else{if(this.currentMethod.substr(9)=="3ds"){var c=new ipaymentApplication();var e=c.buildCcData();c.sendIpaymentRequest(e,_3ds_trxuser_id,"processOnepagecheckoutResponse")}else{var c=new ipaymentApplication();var e=c.buildElvData();c.sendIpaymentRequest(e,elv_trxuser_id,"processOnepagecheckoutResponse")}}}}else{b()}});payment.switchMethod=payment.switchMethod.wrap(function(b,c){b(c);if(c){this.currentMethod=c}})});function ipaymentSwitchEditFields(e,d){if((typeof d=="undefined")||(d=="enable")){$(e+"_edit_switch").style.display="none";d=false}else{$(e+"_edit_switch").style.display="";d=true}var b=$("payment_form_"+payment.currentMethod);var c=b.getElementsByClassName("no-submit");for(var a=0;a<c.length;a++){c[a].disabled=d}}var ipaymentMultishipping=Class.create();ipaymentMultishipping.prototype={initialize:function(){this.form=$("multishipping-billing-form")},validate:function(){var a=document.getElementsByName("payment[method]");if(a.length==0){alert(Translator.translate("Your order can not be completed at this time as there is no payment methods available for it."));return false}for(var b=0;b<a.length;b++){if(a[b].checked){return true}}alert(Translator.translate("Please specify payment method."));return false},save:function(){var b=new Validation(this.form);if(this.validate()&&b.validate()){if(payment.currentMethod.substr(9)=="cc"){var a=new ipaymentApplication();var c=a.buildCcData();a.sendIpaymentRequest(c,cc_trxuser_id,"processMultishippingCcResponse");ipaymentSwitchEditFields(payment.currentMethod,"disable");Element.show("ipayment-cc-please-wait")}if(payment.currentMethod.substr(9)=="elv"){var a=new ipaymentApplication();var c=a.buildElvData();a.sendIpaymentRequest(c,elv_trxuser_id,"processMultishippingElvResponse");Element.show("ipayment-elv-please-wait")}}}};var ipaymentApplication=Class.create();ipaymentApplication.prototype={initialize:function(){},buildCcData:function(){var a={trx_paymenttyp:"cc",addr_name:$(payment.currentMethod+"_cc_owner").value,cc_number:$(payment.currentMethod+"_cc_number").value,cc_expdate_month:$(payment.currentMethod+"_expiration").value,cc_expdate_year:$(payment.currentMethod+"_expiration_yr").value,cc_checkcode:$(payment.currentMethod+"_cc_cid").value,error_lang:document.getElementsByTagName("html")[0].getAttribute("lang")};return a},buildElvData:function(){var a={trx_paymenttyp:"elv",addr_name:$(payment.currentMethod+"_owner").value,bank_code:$(payment.currentMethod+"_bank_code").value,bank_name:$(payment.currentMethod+"_bank_name").value,bank_country:"DE",bank_accountnumber:$(payment.currentMethod+"_account_number").value,error_lang:document.getElementsByTagName("html")[0].getAttribute("lang")};return a},sendIpaymentRequest:function(c,b,d){var a=new IpaymentRequest(c,{return_type:"object",callback_function_name:d},b);a.checkAndStore()}};function processOnepagecheckoutResponse(a){processResponse(a);if(payment.currentMethod.substr(9)=="cc"||payment.currentMethod.substr(9)=="3ds"){ipaymentSwitchEditFields(payment.currentMethod,"disable")}if(a.get("ret_status")=="SUCCESS"){if(a.get("paydata_bank_name")){document.getElementById("ipayment_elv_bank_name").value=a.get("paydata_bank_name")}var b=new Ajax.Request(payment.saveUrl,{method:"post",onComplete:payment.onComplete,onSuccess:payment.onSave,onFailure:checkout.ajaxFailure.bind(checkout),parameters:Form.serialize(payment.form)})}}function processMultishippingCcResponse(a){$("ipayment_cc_request_status").value=a.get("ret_status");Element.hide("ipayment-cc-please-wait");processResponse(a);if(a.get("ret_status")=="SUCCESS"){var c=$("multishipping-billing-form");var e=c.getElementsByClassName("no-submit");for(var b=0;b<e.length;b++){e[b].disabled="disable"}var d=document.getElementById("multishipping-billing-form");d.submit()}if(a.get("ret_status")=="ERROR"){ipaymentSwitchEditFields(payment.currentMethod,"enable")}}function processMultishippingElvResponse(a){$("ipayment_elv_request_status").value=a.get("ret_status");Element.hide("ipayment-elv-please-wait");processResponse(a);if(a.get("ret_status")=="SUCCESS"){var b=document.getElementById("multishipping-billing-form");b.submit()}}function processResponse(a){if(a.get("ret_status")=="SUCCESS"){prepareSubmitedFields(a)}else{if(a.get("ret_status")=="ERROR"){processError(a)}else{alert('Payment status "'+a.get("ret_status")+'" not implemented yet.')}}}function processError(a){alert(a.get("ret_errormsg"));checkout.setLoadWaiting(false);switch(a.get("ret_errorcode")){case"5000":case"5009":break;case"5002":case"5007":break;case"5003":case"5004":break;case"5005":case"5006":break}}function prepareSubmitedFields(a){var c=$("payment_form_"+payment.currentMethod);var d=c.getElementsBySelector("input");for(var b=0;b<d.length;b++){if(d[b].type=="hidden"){switch(d[b].name){case"payment[cc_owner]":d[b].value=$(payment.currentMethod+"_cc_owner").value;break;case"payment[cc_type]":d[b].value=$(payment.currentMethod+"_cc_type").value;break;case"payment[cc_number]":d[b].value=a.get("paydata_cc_number");break;case"payment[cc_exp_month]":d[b].value=$(payment.currentMethod+"_expiration").value;break;case"payment[cc_exp_year]":d[b].value=$(payment.currentMethod+"_expiration_yr").value;break;case"payment[additional_data]":d[b].value=a.get("storage_id");break}}}}function ipaymentCcTypeChanged(a){var b=a.target;if(b.value=="MO"||b.value=="JC"||b.value=="CB"){$$('label[for="ipayment_cc_cc_cid"]').each(function(c){c.select("span.required").each(function(d){d.hide()})})}else{$$('label[for="ipayment_cc_cc_cid"]').each(function(c){c.select("span.required").each(function(d){d.show()})})}};